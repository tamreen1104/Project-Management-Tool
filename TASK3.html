<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Project Tool</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
        }
        .header {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 1rem 1.5rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-button {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .nav-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .section {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: none; /* Hidden by default */
        }
        .section.active {
            display: block; /* Show active section */
        }
        .card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            border: 1px solid #e5e7eb;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .task-column {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            min-height: 200px;
            border: 1px solid #e2e8f0;
        }
        .task-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .task-card:hover {
            transform: translateY(-2px);
        }
        .comment-item {
            background-color: #f0f4f8;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* full rounded */
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-todo { background-color: #fecaca; color: #dc2626; } /* Red 200 / Red 600 */
        .status-in-progress { background-color: #fde68a; color: #d97706; } /* Amber 200 / Amber 700 */
        .status-done { background-color: #d1fae5; color: #059669; } /* Green 200 / Green 600 */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-2xl font-bold">Project Board</h1>
            <div class="flex space-x-4">
                <button id="projectsNav" class="nav-button flex items-center space-x-2"><i class="fas fa-list-alt"></i> <span>Projects</span></button>
                <button id="logoutButton" class="nav-button flex items-center space-x-2"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></button>
            </div>
        </div>

        <!-- Login/Registration Section -->
        <div id="authSection" class="section active p-6 flex flex-col items-center justify-center min-h-[400px]">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome to Project Board</h2>
            <div class="bg-indigo-50 p-8 rounded-xl shadow-lg w-full max-w-md">
                <p class="text-gray-600 mb-4 text-center">Sign in or register to manage your projects!</p>
                <div class="mb-4">
                    <label for="usernameInput" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                    <input type="text" id="usernameInput" placeholder="Enter your username" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                <button id="loginRegisterButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg w-full transition duration-300 ease-in-out transform hover:scale-105">
                    Login / Register
                </button>
                <p id="authMessage" class="text-red-500 text-center mt-4"></p>
                <p class="text-gray-500 text-xs text-center mt-2">Your User ID: <span id="currentUserIdDisplay" class="font-mono bg-gray-200 px-1 py-0.5 rounded">Loading...</span></p>
            </div>
        </div>

        <!-- Projects Dashboard Section -->
        <div id="projectsSection" class="section">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Projects</h2>
            <button id="createProjectButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out">
                <i class="fas fa-plus-circle"></i> Create New Project
            </button>
            <div id="projectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-gray-500 text-center col-span-full">Loading projects...</p>
            </div>
        </div>

        <!-- Project Detail Section -->
        <div id="projectDetailSection" class="section">
            <button id="backToProjectsButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mb-4 transition duration-300 ease-in-out">
                <i class="fas fa-arrow-left"></i> Back to Projects
            </button>
            <h2 id="projectDetailTitle" class="text-3xl font-bold text-indigo-700 mb-2"></h2>
            <p id="projectDetailDescription" class="text-gray-600 mb-4"></p>
            <p class="text-gray-500 text-sm mb-4">Owner: <span id="projectOwnerUsername" class="font-semibold text-indigo-600"></span> | Members: <span id="projectMembers" class="font-semibold text-indigo-600"></span></p>

            <button id="addTaskButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mb-6 transition duration-300 ease-in-out">
                <i class="fas fa-plus-square"></i> Add New Task
            </button>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="task-column">
                    <h3 class="text-xl font-semibold text-red-600 mb-4 flex items-center"><i class="fas fa-hourglass-start mr-2"></i> To Do</h3>
                    <div id="tasksToDo" class="min-h-[100px]">
                        <p class="text-gray-400 text-sm italic">No tasks in To Do.</p>
                    </div>
                </div>
                <div class="task-column">
                    <h3 class="text-xl font-semibold text-amber-700 mb-4 flex items-center"><i class="fas fa-spinner mr-2"></i> In Progress</h3>
                    <div id="tasksInProgress" class="min-h-[100px]">
                        <p class="text-gray-400 text-sm italic">No tasks in In Progress.</p>
                    </div>
                </div>
                <div class="task-column">
                    <h3 class="text-xl font-semibold text-green-600 mb-4 flex items-center"><i class="fas fa-check-circle mr-2"></i> Done</h3>
                    <div id="tasksDone" class="min-h-[100px]">
                        <p class="text-gray-400 text-sm italic">No tasks in Done.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->

        <!-- Create Project Modal -->
        <div id="createProjectModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('createProjectModal').style.display='none'">&times;</span>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Create New Project</h3>
                <div class="mb-4">
                    <label for="newProjectName" class="block text-gray-700 text-sm font-bold mb-2">Project Name:</label>
                    <input type="text" id="newProjectName" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="e.g., Marketing Campaign Q3">
                </div>
                <div class="mb-4">
                    <label for="newProjectDescription" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                    <textarea id="newProjectDescription" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-400" rows="3" placeholder="Brief description of the project"></textarea>
                </div>
                <button id="submitNewProject" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300 ease-in-out">
                    Create Project
                </button>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div id="addTaskModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('addTaskModal').style.display='none'">&times;</span>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Add New Task</h3>
                <div class="mb-4">
                    <label for="newTaskTitle" class="block text-gray-700 text-sm font-bold mb-2">Task Title:</label>
                    <input type="text" id="newTaskTitle" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="e.g., Design landing page">
                </div>
                <div class="mb-4">
                    <label for="newTaskDescription" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                    <textarea id="newTaskDescription" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" rows="3" placeholder="Detailed description of the task"></textarea>
                </div>
                <div class="mb-4">
                    <label for="assignToUser" class="block text-gray-700 text-sm font-bold mb-2">Assign To:</label>
                    <select id="assignToUser" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <button id="submitNewTask" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300 ease-in-out">
                    Add Task
                </button>
            </div>
        </div>

        <!-- Task Detail Modal -->
        <div id="taskDetailModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('taskDetailModal').style.display='none'">&times;</span>
                <h3 id="taskDetailTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
                <p id="taskDetailDescription" class="text-gray-700 mb-4"></p>
                <p class="text-gray-600 text-sm mb-2">Assigned To: <span id="taskDetailAssignedTo" class="font-semibold text-indigo-600"></span></p>
                <p class="text-gray-600 text-sm mb-4">Status: <span id="taskDetailStatus" class="status-badge"></span></p>

                <div class="mb-4">
                    <label for="taskStatusSelect" class="block text-gray-700 text-sm font-bold mb-2">Change Status:</label>
                    <select id="taskStatusSelect" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <option value="todo">To Do</option>
                        <option value="in-progress">In Progress</option>
                        <option value="done">Done</option>
                    </select>
                    <button id="updateTaskStatusButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg mt-2 w-full transition duration-300 ease-in-out">Update Status</button>
                </div>

                <h4 class="text-xl font-semibold text-gray-800 mb-3">Comments</h4>
                <div id="taskCommentsList" class="max-h-60 overflow-y-auto border rounded-lg p-3 mb-4">
                    <p class="text-gray-400 italic">No comments yet.</p>
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="newCommentInput" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-300" placeholder="Add a comment...">
                    <button id="addCommentButton" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        Add
                    </button>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="messageModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('messageModal').style.display='none'">&times;</span>
                <p id="modalMessage" class="text-lg text-center"></p>
                <button onclick="document.getElementById('messageModal').style.display='none'" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg w-full">OK</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration and Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUser = null; // Stores the authenticated user object
        let currentProfile = null; // Stores the user's profile data from Firestore
        let isAuthReady = false; // Flag to ensure Firebase auth is ready before Firestore ops
        let currentProjectId = null; // Stores the ID of the currently viewed project

        // Initialize Firebase app
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showMessageModal("Error initializing Firebase. Please try again later.");
        }

        // --- UI Elements ---
        const authSection = document.getElementById('authSection');
        const projectsSection = document.getElementById('projectsSection');
        const projectDetailSection = document.getElementById('projectDetailSection');

        const usernameInput = document.getElementById('usernameInput');
        const loginRegisterButton = document.getElementById('loginRegisterButton');
        const authMessage = document.getElementById('authMessage');
        const currentUserIdDisplay = document.getElementById('currentUserIdDisplay');

        const projectsNav = document.getElementById('projectsNav');
        const logoutButton = document.getElementById('logoutButton');

        const createProjectButton = document.getElementById('createProjectButton');
        const projectsList = document.getElementById('projectsList');

        const backToProjectsButton = document.getElementById('backToProjectsButton');
        const projectDetailTitle = document.getElementById('projectDetailTitle');
        const projectDetailDescription = document.getElementById('projectDetailDescription');
        const projectOwnerUsername = document.getElementById('projectOwnerUsername');
        const projectMembers = document.getElementById('projectMembers');
        const addTaskButton = document.getElementById('addTaskButton');
        const tasksToDo = document.getElementById('tasksToDo');
        const tasksInProgress = document.getElementById('tasksInProgress');
        const tasksDone = document.getElementById('tasksDone');

        const createProjectModal = document.getElementById('createProjectModal');
        const newProjectNameInput = document.getElementById('newProjectName');
        const newProjectDescriptionInput = document.getElementById('newProjectDescription');
        const submitNewProjectButton = document.getElementById('submitNewProject');

        const addTaskModal = document.getElementById('addTaskModal');
        const newTaskTitleInput = document.getElementById('newTaskTitle');
        const newTaskDescriptionInput = document.getElementById('newTaskDescription');
        const assignToUserSelect = document.getElementById('assignToUser');
        const submitNewTaskButton = document.getElementById('submitNewTask');

        const taskDetailModal = document.getElementById('taskDetailModal');
        const taskDetailTitle = document.getElementById('taskDetailTitle');
        const taskDetailDescription = document.getElementById('taskDetailDescription');
        const taskDetailAssignedTo = document.getElementById('taskDetailAssignedTo');
        const taskDetailStatus = document.getElementById('taskDetailStatus');
        const taskStatusSelect = document.getElementById('taskStatusSelect');
        const updateTaskStatusButton = document.getElementById('updateTaskStatusButton');
        const taskCommentsList = document.getElementById('taskCommentsList');
        const newCommentInput = document.getElementById('newCommentInput');
        const addCommentButton = document.getElementById('addCommentButton');

        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');

        // --- Helper Functions ---
        function showMessageModal(message) {
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleString();
        }

        function getStatusClass(status) {
            switch (status) {
                case 'todo': return 'status-todo';
                case 'in-progress': return 'status-in-progress';
                case 'done': return 'status-done';
                default: return '';
            }
        }

        // --- Authentication Logic ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            isAuthReady = true; // Auth state is now known

            if (user) {
                console.log("User authenticated:", user.uid);
                currentUserIdDisplay.textContent = user.uid;
                await fetchOrCreateUserProfile(user.uid);
                showSection('projectsSection'); // Show projects after successful auth and profile load
                listenToProjects(); // Start listening to projects
            } else {
                console.log("No user authenticated. Signing in...");
                await handleInitialSignIn();
            }
        });

        async function handleInitialSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                showMessageModal("Failed to sign in. Please refresh the page.");
            }
        }

        loginRegisterButton.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (!username) {
                authMessage.textContent = "Username cannot be empty.";
                return;
            }
            authMessage.textContent = "";

            if (!currentUser) {
                showMessageModal("Authentication not ready. Please wait a moment.");
                return;
            }

            // If user is anonymous, try to set up their profile
            if (currentUser.isAnonymous) {
                await fetchOrCreateUserProfile(currentUser.uid, username);
            } else {
                // If already signed in (e.g., with custom token), just ensure profile exists
                await fetchOrCreateUserProfile(currentUser.uid);
            }
            showSection('projectsSection');
        });

        async function fetchOrCreateUserProfile(uid, username = null) {
            const userProfileRef = doc(db, `artifacts/${appId}/users/${uid}/profiles`, uid);
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    currentProfile = docSnap.data();
                    console.log("Existing profile loaded:", currentProfile);
                } else {
                    const newProfile = {
                        username: username || `User_${uid.substring(0, 8)}`,
                        userId: uid,
                        joinedAt: serverTimestamp()
                    };
                    await setDoc(userProfileRef, newProfile);
                    currentProfile = newProfile;
                    console.log("New profile created:", newProfile);
                    showMessageModal(`Welcome, ${currentProfile.username}! Your profile has been created.`);
                }
            } catch (error) {
                console.error("Error fetching/creating user profile:", error);
                showMessageModal("Failed to load or create profile. Please try again.");
            }
        }

        // --- Navigation ---
        projectsNav.addEventListener('click', () => {
            showSection('projectsSection');
            currentProjectId = null; // Reset current project when going back to list
        });
        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                currentUser = null;
                currentProfile = null;
                currentProjectId = null;
                showSection('authSection');
                usernameInput.value = '';
                authMessage.textContent = '';
                currentUserIdDisplay.textContent = 'Loading...';
                projectsList.innerHTML = '<p class="text-gray-500 text-center col-span-full">Loading projects...</p>';
                console.log("User signed out.");
                showMessageModal("You have been signed out.");
            } catch (error) {
                console.error("Error signing out:", error);
                showMessageModal("Error signing out. Please try again.");
            }
        });
        backToProjectsButton.addEventListener('click', () => {
            showSection('projectsSection');
            currentProjectId = null;
        });

        // --- Project Management ---
        createProjectButton.addEventListener('click', () => {
            if (!isAuthReady || !currentUser || !currentProfile) {
                showMessageModal("Please log in to create projects.");
                return;
            }
            createProjectModal.style.display = 'flex';
            newProjectNameInput.value = '';
            newProjectDescriptionInput.value = '';
        });

        submitNewProjectButton.addEventListener('click', async () => {
            const projectName = newProjectNameInput.value.trim();
            const projectDescription = newProjectDescriptionInput.value.trim();

            if (!projectName) {
                showMessageModal("Project name cannot be empty.");
                return;
            }

            try {
                const projectsCollectionRef = collection(db, `artifacts/${appId}/public/data/projects`);
                await addDoc(projectsCollectionRef, {
                    name: projectName,
                    description: projectDescription,
                    ownerId: currentUser.uid,
                    ownerUsername: currentProfile.username,
                    members: [currentUser.uid], // Owner is automatically a member
                    createdAt: serverTimestamp()
                });
                createProjectModal.style.display = 'none';
                showMessageModal("Project created successfully!");
            } catch (error) {
                console.error("Error creating project:", error);
                showMessageModal("Failed to create project. Please try again.");
            }
        });

        function listenToProjects() {
            if (!isAuthReady || !currentUser) {
                console.log("Auth not ready for projects listener.");
                return;
            }
            const projectsCollectionRef = collection(db, `artifacts/${appId}/public/data/projects`);
            // Query projects where the current user is either the owner or a member
            const q = query(projectsCollectionRef, where('members', 'array-contains', currentUser.uid));

            onSnapshot(q, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });

                // Sort projects by creation date (newest first)
                projects.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return b.createdAt.toMillis() - a.createdAt.toMillis();
                    }
                    return 0;
                });

                displayProjects(projects);
            }, (error) => {
                console.error("Error listening to projects:", error);
                projectsList.innerHTML = '<p class="text-red-500 text-center col-span-full">Error loading projects.</p>';
            });
        }

        function displayProjects(projects) {
            projectsList.innerHTML = ''; // Clear existing projects
            if (projects.length === 0) {
                projectsList.innerHTML = '<p class="text-gray-500 text-center col-span-full">No projects yet. Create one to get started!</p>';
                return;
            }

            projects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'card cursor-pointer hover:shadow-lg transition duration-200';
                projectCard.dataset.projectId = project.id;
                projectCard.innerHTML = `
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">${project.name}</h3>
                    <p class="text-gray-600 text-sm mb-3">${project.description}</p>
                    <p class="text-gray-500 text-xs">Owner: <span class="font-semibold">${project.ownerUsername}</span></p>
                    <p class="text-gray-500 text-xs">Members: ${project.members.length}</p>
                    <p class="text-gray-500 text-xs mt-1">Created: ${formatTimestamp(project.createdAt)}</p>
                `;
                projectCard.addEventListener('click', () => viewProjectDetails(project.id));
                projectsList.appendChild(projectCard);
            });
        }

        async function viewProjectDetails(projectId) {
            currentProjectId = projectId;
            showSection('projectDetailSection');

            try {
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
                const projectSnap = await getDoc(projectRef);

                if (projectSnap.exists()) {
                    const projectData = projectSnap.data();
                    projectDetailTitle.textContent = projectData.name;
                    projectDetailDescription.textContent = projectData.description;
                    projectOwnerUsername.textContent = projectData.ownerUsername;

                    // Fetch usernames for members
                    const memberUsernames = [];
                    for (const memberId of projectData.members) {
                        const memberProfileRef = doc(db, `artifacts/${appId}/users/${memberId}/profiles`, memberId);
                        const memberSnap = await getDoc(memberProfileRef);
                        if (memberSnap.exists()) {
                            memberUsernames.push(memberSnap.data().username);
                        } else {
                            memberUsernames.push(`Unknown User (${memberId.substring(0, 4)}...)`);
                        }
                    }
                    projectMembers.textContent = memberUsernames.join(', ');

                    // Populate assignToUserSelect with project members
                    assignToUserSelect.innerHTML = '';
                    memberUsernames.forEach((username, index) => {
                        const option = document.createElement('option');
                        option.value = projectData.members[index]; // Use member ID as value
                        option.textContent = username;
                        assignToUserSelect.appendChild(option);
                    });

                    listenToTasks(projectId); // Start listening to tasks for this project
                } else {
                    showMessageModal("Project not found.");
                    showSection('projectsSection');
                }
            } catch (error) {
                console.error("Error viewing project details:", error);
                showMessageModal("Failed to load project details. Please try again.");
            }
        }

        // --- Task Management ---
        addTaskButton.addEventListener('click', () => {
            if (!currentProjectId) {
                showMessageModal("Please select a project first.");
                return;
            }
            addTaskModal.style.display = 'flex';
            newTaskTitleInput.value = '';
            newTaskDescriptionInput.value = '';
            // assignToUserSelect is populated when project details are loaded
        });

        submitNewTaskButton.addEventListener('click', async () => {
            const taskTitle = newTaskTitleInput.value.trim();
            const taskDescription = newTaskDescriptionInput.value.trim();
            const assignedToId = assignToUserSelect.value;
            const assignedToUsername = assignToUserSelect.options[assignToUserSelect.selectedIndex].text;

            if (!taskTitle || !assignedToId) {
                showMessageModal("Task title and assignee are required.");
                return;
            }
            if (!currentProjectId) {
                showMessageModal("No project selected to add task to.");
                return;
            }

            try {
                const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/projects/${currentProjectId}/tasks`);
                await addDoc(tasksCollectionRef, {
                    projectId: currentProjectId,
                    title: taskTitle,
                    description: taskDescription,
                    assignedToId: assignedToId,
                    assignedToUsername: assignedToUsername,
                    status: 'todo', // Default status
                    createdAt: serverTimestamp()
                });
                addTaskModal.style.display = 'none';
                showMessageModal("Task added successfully!");
            } catch (error) {
                console.error("Error adding task:", error);
                showMessageModal("Failed to add task. Please try again.");
            }
        });

        function listenToTasks(projectId) {
            const tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/projects/${projectId}/tasks`);
            const q = query(tasksCollectionRef); // Firestore does not support orderBy without index, so we sort in JS

            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                // Sort tasks by creation date (oldest first for display within columns)
                tasks.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return a.createdAt.toMillis() - b.createdAt.toMillis();
                    }
                    return 0;
                });

                displayTasks(tasks);
            }, (error) => {
                console.error("Error listening to tasks:", error);
                tasksToDo.innerHTML = '<p class="text-red-500 text-sm italic">Error loading tasks.</p>';
                tasksInProgress.innerHTML = '<p class="text-red-500 text-sm italic">Error loading tasks.</p>';
                tasksDone.innerHTML = '<p class="text-red-500 text-sm italic">Error loading tasks.</p>';
            });
        }

        function displayTasks(tasks) {
            tasksToDo.innerHTML = '<p class="text-gray-400 text-sm italic">No tasks in To Do.</p>';
            tasksInProgress.innerHTML = '<p class="text-gray-400 text-sm italic">No tasks in In Progress.</p>';
            tasksDone.innerHTML = '<p class="text-gray-400 text-sm italic">No tasks in Done.</p>';

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                taskCard.dataset.taskId = task.id;
                taskCard.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-1">${task.title}</h4>
                    <p class="text-gray-600 text-sm mb-2 line-clamp-2">${task.description}</p>
                    <p class="text-gray-500 text-xs">Assigned: ${task.assignedToUsername}</p>
                    <span class="status-badge ${getStatusClass(task.status)} mt-2 inline-block">${task.status}</span>
                `;
                taskCard.addEventListener('click', () => openTaskDetailModal(task));

                switch (task.status) {
                    case 'todo':
                        if (tasksToDo.querySelector('p')) tasksToDo.innerHTML = ''; // Remove placeholder
                        tasksToDo.appendChild(taskCard);
                        break;
                    case 'in-progress':
                        if (tasksInProgress.querySelector('p')) tasksInProgress.innerHTML = '';
                        tasksInProgress.appendChild(taskCard);
                        break;
                    case 'done':
                        if (tasksDone.querySelector('p')) tasksDone.innerHTML = '';
                        tasksDone.appendChild(taskCard);
                        break;
                }
            });
        }

        let currentTaskId = null; // To keep track of the task being viewed/edited in the modal

        async function openTaskDetailModal(task) {
            currentTaskId = task.id;
            taskDetailTitle.textContent = task.title;
            taskDetailDescription.textContent = task.description;
            taskDetailAssignedTo.textContent = task.assignedToUsername;
            taskDetailStatus.textContent = task.status;
            taskDetailStatus.className = `status-badge ${getStatusClass(task.status)}`;
            taskStatusSelect.value = task.status; // Set current status in dropdown

            // Listen to comments for this specific task
            listenToTaskComments(currentProjectId, currentTaskId);

            taskDetailModal.style.display = 'flex';
        }

        updateTaskStatusButton.addEventListener('click', async () => {
            if (!currentProjectId || !currentTaskId) {
                showMessageModal("No task selected for status update.");
                return;
            }
            const newStatus = taskStatusSelect.value;
            try {
                const taskRef = doc(db, `artifacts/${appId}/public/data/projects/${currentProjectId}/tasks`, currentTaskId);
                await updateDoc(taskRef, { status: newStatus });
                showMessageModal("Task status updated successfully!");
                taskDetailModal.style.display = 'none'; // Close modal after update
            } catch (error) {
                console.error("Error updating task status:", error);
                showMessageModal("Failed to update task status. Please try again.");
            }
        });

        // --- Comment System ---
        addCommentButton.addEventListener('click', async () => {
            const commentContent = newCommentInput.value.trim();
            if (!commentContent) {
                showMessageModal("Comment cannot be empty.");
                return;
            }
            if (!currentProjectId || !currentTaskId || !currentUser || !currentProfile) {
                showMessageModal("Cannot add comment. Please ensure you are logged in and a task is selected.");
                return;
            }

            try {
                const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/projects/${currentProjectId}/tasks/${currentTaskId}/comments`);
                await addDoc(commentsCollectionRef, {
                    userId: currentUser.uid,
                    username: currentProfile.username,
                    content: commentContent,
                    timestamp: serverTimestamp(),
                    taskId: currentTaskId,
                    projectId: currentProjectId
                });
                newCommentInput.value = ''; // Clear input
                console.log("Comment added successfully.");
            } catch (error) {
                console.error("Error adding comment:", error);
                showMessageModal("Failed to add comment. Please try again.");
            }
        });

        function listenToTaskComments(projectId, taskId) {
            const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/projects/${projectId}/tasks/${taskId}/comments`);
            const q = query(commentsCollectionRef); // Firestore does not support orderBy without index, so we sort in JS

            onSnapshot(q, (snapshot) => {
                const comments = [];
                snapshot.forEach(doc => {
                    comments.push({ id: doc.id, ...doc.data() });
                });

                // Sort comments by timestamp (oldest first)
                comments.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        return a.timestamp.toMillis() - b.timestamp.toMillis();
                    }
                    return 0;
                });

                taskCommentsList.innerHTML = ''; // Clear existing comments
                if (comments.length === 0) {
                    taskCommentsList.innerHTML = '<p class="text-gray-400 italic">No comments yet.</p>';
                } else {
                    comments.forEach(comment => {
                        const commentItem = document.createElement('div');
                        commentItem.className = 'comment-item';
                        commentItem.innerHTML = `
                            <p class="font-semibold text-gray-700 text-sm">${comment.username} <span class="text-gray-500 text-xs font-normal ml-2">${formatTimestamp(comment.timestamp)}</span></p>
                            <p class="text-gray-600 text-sm">${comment.content}</p>
                        `;
                        taskCommentsList.appendChild(commentItem);
                    });
                }
            }, (error) => {
                console.error(`Error listening to comments for task ${taskId}:`, error);
                taskCommentsList.innerHTML = '<p class="text-red-500 text-sm italic">Error loading comments.</p>';
            });
        }

        // Initial check for auth state and setup is handled by onAuthStateChanged.
        // No need for a separate window.onload or DOMContentLoaded listener here.
    </script>
</body>
</html>
